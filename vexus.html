<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quantificador VExUS &ndash; Congest√£o Venosa Sist√™mica</title>
<style>
  :root{
    --bg: #0b1220;
    --panel:#121a2b;
    --ink:#e7ecf6;
    --muted:#9fb2d0;
    --brand:#5aa9ff;
    --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c;
    --border: #223253;
  }
  html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
  body{background:var(--bg);color:var(--ink);}
  .wrap{max-width:1050px;margin:24px auto;padding:0 16px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .title{font-weight:700;font-size:1.25rem;letter-spacing:.2px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px}
  .controls{display:flex;flex-direction:column;gap:12px}
  select, input[type="number"], input[type="text"], button, textarea{background:#0e1626;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px}
  select option{background:#f0f2f9;color:#0b1220}
  select option:checked{background:#f0f2f9;color:#0b1220;outline:none}
  select option:hover, select option:focus{background:#5aa9ff;color:#0b1220}
  select:focus, input:focus, textarea:focus, button:focus{outline:2px solid var(--brand);outline-offset:1px}
  .row{display:flex;gap:8px;align-items:center}
  .row label{font-size:.85rem;color:var(--muted)}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .tile{background:#0f1a2d;border:1px solid var(--border);border-radius:14px;padding:12px}
  .tile h5{margin:0;font-size:.8rem;color:var(--muted)}
  .tile .val{font-size:1.2rem;font-weight:700;margin-top:6px}
  .badge{border-radius:999px;padding:.25rem .6rem;font-weight:700;font-size:.78rem}
  .ok{background:rgba(46,204,113,.15);color:#79e5a9;border:1px solid rgba(46,204,113,.35)}
  .warn{background:rgba(241,196,15,.12);color:#ffe28a;border:1px solid rgba(241,196,15,.35)}
  .bad{background:rgba(231,76,60,.12);color:#ff9f96;border:1px solid rgba(231,76,60,.35)}
  .muted{color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:16px 0}
  textarea{width:100%;min-height:120px;resize:vertical}
  .select-level{transition:background .2s, border-color .2s, color .2s}
  .level-neutral{background:#0e1626;color:var(--ink);border-color:var(--border)}
  .level-normal{background:rgba(46,204,113,.18);color:#b7f7cf;border-color:rgba(46,204,113,.4)}
  .level-mild{background:rgba(241,196,15,.18);color:#ffe7a0;border-color:rgba(241,196,15,.45)}
  .level-severe{background:rgba(231,76,60,.2);color:#ffc1ba;border-color:rgba(231,76,60,.5)}
  .level-missing{background:rgba(159,178,208,.2);color:#d2daeb;border-color:rgba(159,178,208,.4)}
  .footer-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .primary{background:linear-gradient(180deg,#5aa9ff,#347bd9);border:none}
  .ghost{background:transparent}
  .mini{padding:6px 10px;border-radius:10px}
  .caption{font-size:.82rem;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ü´Ä VExUS &ndash; Quantificador de Congest√£o Venosa Sist√™mica</div>
    <button class="mini ghost" id="btnReset" type="button">Reiniciar</button>
  </header>

  <section class="card">
    <div class="controls">
      <label class="row ctrl">
        <span class="grow">Veia cava inferior</span>
        <select id="ivc">
          <option value="normal" selected>&le;2 cm + colapso respirat√≥rio &gt;50%</option>
          <option value="abnormal">&gt;2 cm ou colapso &lt;50%</option>
          <option value="indisponivel">N√£o avaliada / janela ruim</option>
        </select>
      </label>

      <label class="row ctrl">
        <span class="grow">Veia hep√°tica</span>
        <select id="hepatic">
          <option value="normal" selected>Padr√£o fisiol√≥gico (S &gt; D)</option>
          <option value="mild">Congest√£o leve (S &lt; D, ainda anter√≥grada)</option>
          <option value="severe">Congest√£o grave (S reverso/bidirecional)</option>
        </select>
      </label>

      <label class="row ctrl">
        <span class="grow">Veia porta</span>
        <select id="portal">
          <option value="normal" selected>Pulsatilidade &lt;30%</option>
          <option value="mild">Pulsatilidade 30-50%</option>
          <option value="severe">Pulsatilidade &gt;50% / fluxo bidirecional</option>
        </select>
      </label>

      <label class="row ctrl">
        <span class="grow">Veia renal interlobar (opcional)</span>
        <select id="renal">
          <option value="nao" selected>N√£o avaliada</option>
          <option value="normal">Fluxo cont√≠nuo</option>
          <option value="mild">Desacelera√ß√£o/aus√™ncia diast√≥lica</option>
          <option value="severe">Fluxo reverso diast√≥lico</option>
        </select>
      </label>

      <label class="row ctrl ctrl-wide">
        <span class="grow">Observa√ß√µes r√°pidas</span>
        <input id="notes" placeholder="Ex.: ap√≥s expans√£o vol√™mica, uso de aminas, etc." />
      </label>
    </div>

    <div class="divider"></div>

    <div class="kpi">
      <div class="tile">
        <h5>Classifica√ß√£o VExUS</h5>
        <div class="val"><span id="grade" class="badge ok">VExUS 0</span></div>
      </div>
      <div class="tile">
        <h5>Crit√©rios positivos</h5>
        <div class="val" id="positiveCount">0</div>
      </div>
      <div class="tile">
        <h5>Estado da Veia cava inferior</h5>
        <div class="val" id="ivcSummary">Normal</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="footer-actions">
      <button class="primary" id="btnReport" type="button">Gerar relat√≥rio</button>
      <button class="ghost" id="btnCopy" type="button">Copiar relat√≥rio</button>
      <button class="ghost" id="btnSave" type="button">Salvar JSON</button>
      <input type="file" id="fileLoad" accept="application/json" style="display:none" />
      <button class="ghost" id="btnLoad" type="button">Carregar JSON</button>
    </div>

    <div class="divider"></div>
    <div>
      <label class="row"><span class="grow">Relat√≥rio</span></label>
      <textarea id="report" placeholder="Clique em 'Gerar relat√≥rio' para compor o texto padronizado."></textarea>
    </div>
  </section>
</div>

<script>
(function(){
  const ivcEl = document.getElementById('ivc');
  const hepaticEl = document.getElementById('hepatic');
  const portalEl = document.getElementById('portal');
  const renalEl = document.getElementById('renal');
  const notesEl = document.getElementById('notes');
  const reportEl = document.getElementById('report');

  const gradeEl = document.getElementById('grade');
  const positiveCountEl = document.getElementById('positiveCount');
  const ivcSummaryEl = document.getElementById('ivcSummary');

  const btnReport = document.getElementById('btnReport');
  const btnCopy = document.getElementById('btnCopy');
  const btnReset = document.getElementById('btnReset');
  const btnSave = document.getElementById('btnSave');
  const btnLoad = document.getElementById('btnLoad');
  const fileLoad = document.getElementById('fileLoad');

  const OPTIONS = {
    ivc:{
      normal:{label:'<=2 cm e varia√ß√£o respirat√≥ria preservada', severity:0},
      abnormal:{label:'>2 cm ou colapso <50%', severity:1},
      indisponivel:{label:'N√£o avaliada', severity:null}
    },
    hepatic:{
      normal:{label:'S>D, fluxo predominantemente anter√≥grado', severity:0},
      mild:{label:'S<D, por√©m sem revers√£o', severity:1},
      severe:{label:'S reverso/bidirecional', severity:2}
    },
    portal:{
      normal:{label:'Pulsatilidade <30%', severity:0},
      mild:{label:'Pulsatilidade 30-50%', severity:1},
      severe:{label:'Pulsatilidade >50% ou fluxo bidirecional', severity:2}
    },
    renal:{
      nao:{label:'N√£o avaliada', severity:null},
      normal:{label:'Fluxo cont√≠nuo trif√°sico', severity:0},
      mild:{label:'Desacelera√ß√£o/aus√™ncia de fase diast√≥lica', severity:1},
      severe:{label:'Fluxo reverso na di√°stole', severity:2}
    }
  };

  let state = {
    ivc:'normal',
    hepatic:'normal',
    portal:'normal',
    renal:'nao',
    notes:''
  };

  function tintSelect(el, severity){
    const cls = ['level-neutral','level-normal','level-mild','level-severe','level-missing'];
    el.classList.add('select-level');
    cls.forEach(c=>el.classList.remove(c));
    let target = 'level-neutral';
    if(severity === null){
      target = 'level-missing';
    }else if(severity === 0){
      target = 'level-normal';
    }else if(severity === 1){
      target = 'level-mild';
    }else if(severity >= 2){
      target = 'level-severe';
    }
    el.classList.add(target);
  }

  function evaluate(){
    const ivc = state.ivc;
    const values = [];

    const hepatic = OPTIONS.hepatic[state.hepatic];
    const portal = OPTIONS.portal[state.portal];
    const renal = OPTIONS.renal[state.renal];

    values.push({name:'Veia hep√°tica', key:'hepatic', include:true, severity:hepatic.severity, text:hepatic.label});
    values.push({name:'Veia porta', key:'portal', include:true, severity:portal.severity, text:portal.label});
    if(state.renal !== 'nao'){
      values.push({name:'Veia renal', key:'renal', include:true, severity:renal.severity, text:renal.label});
    }

    const positive = values.filter(v=>typeof v.severity==='number' && v.severity>0).length;
    positiveCountEl.textContent = positive.toString();

    const ivcData = OPTIONS.ivc[ivc];
    ivcSummaryEl.textContent = ivcData ? ivcData.label : 'N/A';

    tintSelect(ivcEl, ivcData ? ivcData.severity : null);
    tintSelect(hepaticEl, hepatic.severity);
    tintSelect(portalEl, portal.severity);
    tintSelect(renalEl, state.renal === 'nao' ? null : renal.severity);

    const includeRenal = state.renal !== 'nao';
    const result = computeStage(ivcData ? ivcData.severity : null, values, includeRenal);
    gradeEl.textContent = result.label;
    gradeEl.className = 'badge ' + result.badge;
    return result;
  }

  function computeStage(ivcSeverity, values, includeRenal){
    const prefix = includeRenal ? 'VExUS' : 'mVExUS';
    if(ivcSeverity === null){
      return {stage:'N/A', label:`${prefix}: dados incompletos`, badge:'warn'};
    }
    if(ivcSeverity === 0){
      return {stage:0, label:`${prefix} 0 (sem congest√£o significativa)`, badge:'ok'};
    }

    if(!includeRenal){
      const hepatic = values.find(v=>v.key==='hepatic');
      const portal = values.find(v=>v.key==='portal');
      const hepaticSevere = hepatic && hepatic.severity === 2;
      const portalSevere = portal && portal.severity === 2;
      if(hepaticSevere && portalSevere){
        return {stage:3, label:'mVExUS 3 (congest√£o grave)', badge:'bad'};
      }
      if(hepaticSevere || portalSevere){
        return {stage:2, label:'mVExUS 2 (congest√£o moderada)', badge:'warn'};
      }
      return {stage:1, label:'mVExUS 1 (congest√£o leve)', badge:'warn'};
    }

    const maxSeverity = values.reduce((acc,item)=>{
      const lvl = typeof item.severity==='number' ? item.severity : 0;
      return Math.max(acc, lvl);
    },0);

    if(maxSeverity === 0){
      return {stage:1, label:'VExUS I (congest√£o leve)', badge:'warn'};
    }else if(maxSeverity === 1){
      return {stage:2, label:'VExUS II (congest√£o moderada)', badge:'warn'};
    }
    return {stage:3, label:'VExUS III (congest√£o grave)', badge:'bad'};
  }

  function compute(){
    state.ivc = ivcEl.value;
    state.hepatic = hepaticEl.value;
    state.portal = portalEl.value;
    state.renal = renalEl.value;
    state.notes = notesEl.value.trim();
    return evaluate();
  }

  function generateReport(){
    const result = compute();
    const methodName = state.renal === 'nao' ? 'mVExUS' : 'VExUS';
    const parts = [];
    parts.push(`Ultrassonografia point-of-care para congest√£o venosa (${methodName}).`);
    parts.push('Veia cava inferior: ' + OPTIONS.ivc[state.ivc].label + '.');
    parts.push('Veia hep√°tica: ' + OPTIONS.hepatic[state.hepatic].label + '.');
    parts.push('Veia porta: ' + OPTIONS.portal[state.portal].label + '.');
    if(state.renal !== 'nao'){
      parts.push('Veia renal interlobar: ' + OPTIONS.renal[state.renal].label + '.');
    }else{
      parts.push('Veia renal n√£o avaliada.');
    }
    parts.push('Classifica√ß√£o final: ' + result.label + '.');
    parts.push('Crit√©rios positivos contabilizados: ' + positiveCountEl.textContent + '.');
    if(state.notes){
      parts.push('Observa√ß√µes: ' + state.notes + '.');
    }
    parts.push('Interpreta√ß√£o baseada nos limiares originais do escore VExUS.');
    reportEl.value = parts.join('\n');
  }
  window.generateReport = generateReport;

  function resetAll(){
    ivcEl.value = 'normal';
    hepaticEl.value = 'normal';
    portalEl.value = 'normal';
    renalEl.value = 'nao';
    notesEl.value = '';
    reportEl.value = '';
    compute();
  }

  function saveJSON(){
    const data = {
      meta:{tool:'vexus', ts:new Date().toISOString()},
      form:{...state}
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vexus_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function loadJSON(file){
    const reader = new FileReader();
    reader.onload = (evt)=>{
      try{
        const data = JSON.parse(evt.target.result);
        const form = data.form || data;
        if(form.ivc) ivcEl.value = form.ivc;
        if(form.hepatic) hepaticEl.value = form.hepatic;
        if(form.portal) portalEl.value = form.portal;
        if(form.renal) renalEl.value = form.renal;
        if(typeof form.notes === 'string') notesEl.value = form.notes;
        compute();
      }catch(err){
        alert('Arquivo inv√°lido.');
      }
    };
    reader.readAsText(file);
  }

  ivcEl.addEventListener('change', compute);
  hepaticEl.addEventListener('change', compute);
  portalEl.addEventListener('change', compute);
  renalEl.addEventListener('change', compute);
  notesEl.addEventListener('input', compute);

  btnReport.addEventListener('click', generateReport);
  btnCopy.addEventListener('click', ()=>{
    reportEl.select();
    document.execCommand('copy');
  });
  btnReset.addEventListener('click', resetAll);
  btnSave.addEventListener('click', saveJSON);
  btnLoad.addEventListener('click', ()=>fileLoad.click());
  fileLoad.addEventListener('change', ()=>{
    if(fileLoad.files && fileLoad.files[0]){
      loadJSON(fileLoad.files[0]);
    }
  });

  compute();
})();
</script>
</body>
</html>
